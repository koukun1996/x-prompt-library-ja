"""
プロンプトテンプレート集

目的別のプロンプトテンプレートを定義する。
テンプレートは自然言語ベースで、パラメータを埋め込むことで動的にプロンプトを生成する。
全テンプレートに共通サフィックス（日本語応答・Markdown構造化出力）が自動付加される。
"""

# 全テンプレート共通の末尾指示
COMMON_SUFFIX = (
    "\n\n---\n"
    "すべての回答は日本語で行ってください。\n"
    "回答は Markdown 形式で、見出しは ## から始めてください。\n"
    "具体的な投稿を引用する場合は、投稿者の @ハンドル名とおおよその投稿日時を含めてください。\n"
    "情報の確度が低い場合は「（未確認）」と注記してください。"
)

TEMPLATES: dict[str, dict] = {
    # =========================================================================
    # ユースケース1: 特定ユーザーの投稿監視
    # =========================================================================
    "user_monitor": {
        "description": "特定ユーザーの直近の投稿を監視・要約する",
        "params": ["handle", "hours"],
        "optional_params": [],
        "template": (
            "X (Twitter) で検索して、ユーザー {handle} の直近 {hours} 時間の投稿を調査してください。\n"
            "\n"
            "以下のセクションに分けて報告してください:\n"
            "\n"
            "## 投稿一覧\n"
            "- 各投稿の内容を時系列（新しい順）で要約してください\n"
            "- 各投稿におおよその投稿日時を併記してください\n"
            "\n"
            "## 主要トピック\n"
            "- 投稿全体を通じた主要なトピックやテーマを整理してください\n"
            "\n"
            "## 注目投稿\n"
            "- エンゲージメント（返信・リポスト・いいね）が多いと推定される投稿をピックアップしてください\n"
            "- なぜ注目に値するか、簡潔な理由を添えてください\n"
            "\n"
            "## 全体傾向\n"
            "- 発信のトーン（積極的、慎重、批判的など）を評価してください"
        ),
    },
    # =========================================================================
    # ユースケース2: キーワード/トピック調査
    # =========================================================================
    "topic_research": {
        "description": "特定トピックに関する X の議論を調査する",
        "params": ["keyword"],
        "optional_params": ["hours"],
        "template": (
            "X (Twitter) で「{keyword}」に関する最新の議論を検索して調査してください。\n"
            "\n"
            "以下のセクションに分けて報告してください:\n"
            "\n"
            "## 議論の概要\n"
            "- 「{keyword}」について現在 X でどのような議論が行われているか、全体像を要約してください\n"
            "\n"
            "## 主要な意見・立場\n"
            "- 賛成派・反対派・中立派など、主要な立場を整理してください\n"
            "- 各立場の代表的な主張を箇条書きで示してください\n"
            "\n"
            "## 注目アカウントの発言\n"
            "- 影響力のあるアカウント（専門家、公式アカウントなど）の発言を引用してください\n"
            "- 各発言にハンドル名を併記してください\n"
            "\n"
            "## 関連キーワード\n"
            "- この議論に関連するハッシュタグやキーワードをリストアップしてください\n"
            "- 今後の深掘り調査に役立つ関連トピックがあれば含めてください"
        ),
        # hours が指定された場合に使用するバリアント
        "template_with_hours": (
            "X (Twitter) で「{keyword}」に関する直近 {hours} 時間の議論を検索して調査してください。\n"
            "\n"
            "以下のセクションに分けて報告してください:\n"
            "\n"
            "## 議論の概要\n"
            "- 「{keyword}」について現在 X でどのような議論が行われているか、全体像を要約してください\n"
            "\n"
            "## 主要な意見・立場\n"
            "- 賛成派・反対派・中立派など、主要な立場を整理してください\n"
            "- 各立場の代表的な主張を箇条書きで示してください\n"
            "\n"
            "## 注目アカウントの発言\n"
            "- 影響力のあるアカウント（専門家、公式アカウントなど）の発言を引用してください\n"
            "- 各発言にハンドル名を併記してください\n"
            "\n"
            "## 関連キーワード\n"
            "- この議論に関連するハッシュタグやキーワードをリストアップしてください\n"
            "- 今後の深掘り調査に役立つ関連トピックがあれば含めてください"
        ),
    },
    # =========================================================================
    # ユースケース3: トレンド分析
    # =========================================================================
    "trend_analysis": {
        "description": "トレンドを分析する（トピック指定は任意）",
        "params": [],
        "optional_params": ["topic"],
        "template": (
            "X (Twitter) で検索して、「{topic}」に関する現在のトレンドを分析してください。\n"
            "\n"
            "以下のセクションに分けて報告してください:\n"
            "\n"
            "## トレンドの現状\n"
            "- 現在 X でどの程度話題になっているか、盛り上がりの度合いを評価してください\n"
            "- いつ頃から注目が集まり始めたか、可能であれば時系列を示してください\n"
            "\n"
            "## 話題の中心\n"
            "- 議論の中心となっているサブトピックや論点を整理してください\n"
            "\n"
            "## キーパーソン\n"
            "- このトレンドに関して影響力のある発言をしているアカウントを挙げてください\n"
            "- 各アカウントの立場や主張を簡潔に記述してください\n"
            "\n"
            "## 今後の展望\n"
            "- このトレンドが今後どのように推移するか、X 上の議論から読み取れる兆候を報告してください\n"
            "- 関連する予定イベント（発表、決定、リリースなど）があれば含めてください"
        ),
        # topic が未指定の場合に使用するバリアント
        "template_default": (
            "X (Twitter) で検索して、現在日本語圏で話題になっているトレンドを分析してください。\n"
            "\n"
            "以下のセクションに分けて報告してください:\n"
            "\n"
            "## 主要トレンド一覧\n"
            "- 現在 X で最も話題になっているトピックを5つ程度、重要度順にリストアップしてください\n"
            "- 各トピックに1〜2文の概要を添えてください\n"
            "\n"
            "## 各トレンドの詳細\n"
            "- 各トピックについて、何が起きているか、なぜ話題になっているかを説明してください\n"
            "\n"
            "## 注目すべき動き\n"
            "- まだ大きな話題にはなっていないが、今後注目すべき兆候があればピックアップしてください"
        ),
    },
    # =========================================================================
    # ユースケース4: スレッド要約
    # =========================================================================
    "thread_summary": {
        "description": "特定のスレッドやディスカッションを要約する",
        "params": ["url"],
        "optional_params": [],
        "template": (
            "X (Twitter) で以下のスレッドまたはディスカッションを検索して、内容を要約してください:\n"
            "{url}\n"
            "\n"
            "以下のセクションに分けて報告してください:\n"
            "\n"
            "## スレッドの概要\n"
            "- スレッドの主旨を1〜3文で要約してください\n"
            "- 投稿者のハンドル名と投稿日時を含めてください\n"
            "\n"
            "## 主要ポイント\n"
            "- スレッドの各投稿の要点を、元の投稿順に箇条書きで整理してください\n"
            "\n"
            "## 注目リプライ\n"
            "- スレッドに対する返信の中で、特に注目すべきもの（反論、補足、専門的指摘など）をピックアップしてください\n"
            "- 各リプライの投稿者ハンドル名を併記してください\n"
            "\n"
            "## まとめ\n"
            "- スレッド全体の結論または要点を、3つ以内の箇条書きで整理してください"
        ),
    },
    # =========================================================================
    # 追加テンプレート: 2アカウント比較
    # =========================================================================
    "comparative": {
        "description": "2つのアカウントの発言を比較分析する",
        "params": ["handle1", "handle2"],
        "optional_params": ["hours"],
        "template": (
            "X (Twitter) で検索して、ユーザー {handle1} と {handle2} の直近の発言を比較分析してください。\n"
            "\n"
            "以下のセクションに分けて報告してください:\n"
            "\n"
            "## {handle1} の主要な発言\n"
            "- 直近の主要な投稿内容を要約してください\n"
            "\n"
            "## {handle2} の主要な発言\n"
            "- 直近の主要な投稿内容を要約してください\n"
            "\n"
            "## 共通点と相違点\n"
            "- 両者の発言に見られる共通のトピックやスタンスを整理してください\n"
            "- 意見が異なる点を明確に対比してください\n"
            "\n"
            "## トーン・スタンスの比較\n"
            "- それぞれの発信のトーン（積極的、慎重、攻撃的など）を評価してください\n"
            "\n"
            "## 相互のやり取り\n"
            "- 両者間の直接のやり取り（リプライ、引用リポストなど）があれば報告してください\n"
            "- やり取りがない場合は「直接のやり取りは確認されませんでした」と記載してください"
        ),
        "template_with_hours": (
            "X (Twitter) で検索して、ユーザー {handle1} と {handle2} の直近 {hours} 時間の発言を比較分析してください。\n"
            "\n"
            "以下のセクションに分けて報告してください:\n"
            "\n"
            "## {handle1} の主要な発言\n"
            "- 直近 {hours} 時間の主要な投稿内容を要約してください\n"
            "\n"
            "## {handle2} の主要な発言\n"
            "- 直近 {hours} 時間の主要な投稿内容を要約してください\n"
            "\n"
            "## 共通点と相違点\n"
            "- 両者の発言に見られる共通のトピックやスタンスを整理してください\n"
            "- 意見が異なる点を明確に対比してください\n"
            "\n"
            "## トーン・スタンスの比較\n"
            "- それぞれの発信のトーン（積極的、慎重、攻撃的など）を評価してください\n"
            "\n"
            "## 相互のやり取り\n"
            "- 両者間の直接のやり取り（リプライ、引用リポストなど）があれば報告してください\n"
            "- やり取りがない場合は「直接のやり取りは確認されませんでした」と記載してください"
        ),
    },
    # =========================================================================
    # 追加テンプレート: 感情分析
    # =========================================================================
    "sentiment": {
        "description": "特定トピックに対する感情分析を行う",
        "params": ["keyword"],
        "optional_params": ["hours"],
        "template": (
            "X (Twitter) で「{keyword}」に対する感情（センチメント）を検索して分析してください。\n"
            "\n"
            "以下のセクションに分けて報告してください:\n"
            "\n"
            "## 全体的な感情傾向\n"
            "- ポジティブ・ネガティブ・ニュートラルのおおよその割合を推定してください\n"
            "- 全体としてどのような感情が支配的かを1〜2文で要約してください\n"
            "\n"
            "## ポジティブな意見\n"
            "- 代表的なポジティブな意見を3〜5件挙げてください\n"
            "- 各意見の投稿者ハンドル名を併記してください\n"
            "\n"
            "## ネガティブな意見\n"
            "- 代表的なネガティブな意見を3〜5件挙げてください\n"
            "- 各意見の投稿者ハンドル名を併記してください\n"
            "\n"
            "## 感情の変化\n"
            "- 時間の経過とともに感情傾向に変化が見られるか報告してください\n"
            "- 特定のイベントや発言が感情の転換点になっていれば指摘してください"
        ),
        "template_with_hours": (
            "X (Twitter) で「{keyword}」に対する直近 {hours} 時間の感情（センチメント）を検索して分析してください。\n"
            "\n"
            "以下のセクションに分けて報告してください:\n"
            "\n"
            "## 全体的な感情傾向\n"
            "- ポジティブ・ネガティブ・ニュートラルのおおよその割合を推定してください\n"
            "- 全体としてどのような感情が支配的かを1〜2文で要約してください\n"
            "\n"
            "## ポジティブな意見\n"
            "- 代表的なポジティブな意見を3〜5件挙げてください\n"
            "- 各意見の投稿者ハンドル名を併記してください\n"
            "\n"
            "## ネガティブな意見\n"
            "- 代表的なネガティブな意見を3〜5件挙げてください\n"
            "- 各意見の投稿者ハンドル名を併記してください\n"
            "\n"
            "## 感情の変化\n"
            "- 直近 {hours} 時間で感情傾向に変化が見られるか報告してください\n"
            "- 特定のイベントや発言が感情の転換点になっていれば指摘してください"
        ),
    },
    # =========================================================================
    # 追加テンプレート: 速報ニュース
    # =========================================================================
    "breaking_news": {
        "description": "速報・ニュースに関する X の反応を調査する",
        "params": ["keyword"],
        "optional_params": [],
        "template": (
            "X (Twitter) で「{keyword}」に関する最新の反応を検索して調査してください。\n"
            "\n"
            "以下のセクションに分けて報告してください:\n"
            "\n"
            "## 事実関係の整理\n"
            "- 確認済みの情報を箇条書きで整理してください\n"
            "- 未確認の情報には「（未確認）」と明記してください\n"
            "\n"
            "## 公式・メディアの発信\n"
            "- 主要メディアや公式アカウントの発信内容を引用してください\n"
            "- 各発信にハンドル名と投稿日時を併記してください\n"
            "\n"
            "## 一般ユーザーの反応\n"
            "- 一般ユーザーの主要な反応パターンを整理してください\n"
            "- 特に注目すべき反応があれば引用してください\n"
            "\n"
            "## 誤情報・注意事項\n"
            "- 拡散されている誤情報や憶測があれば指摘してください\n"
            "- ファクトチェックの結果があれば含めてください\n"
            "- 誤情報が確認されない場合は「現時点で目立った誤情報は確認されていません」と記載してください"
        ),
    },
    # =========================================================================
    # 自由形式
    # =========================================================================
    "freeform": {
        "description": "自由形式のクエリをそのまま送信する",
        "params": ["query"],
        "optional_params": [],
        "template": "{query}",
    },
}


def build_prompt(template_name: str, **kwargs) -> str:
    """
    テンプレート名とパラメータからプロンプト文字列を生成する。

    全テンプレートに共通サフィックス（日本語応答・Markdown 構造化出力指示）を
    自動付加する。任意パラメータの有無に応じてテンプレートバリアントを選択する。

    Args:
        template_name: テンプレート名（TEMPLATES のキー）
        **kwargs: テンプレートに埋め込むパラメータ

    Returns:
        生成されたプロンプト文字列（共通サフィックス付き）

    Raises:
        KeyError: 指定されたテンプレートが存在しない場合
        KeyError: 必要なパラメータが不足している場合
    """
    if template_name not in TEMPLATES:
        available = ", ".join(TEMPLATES.keys())
        raise KeyError(
            f"テンプレート '{template_name}' が見つかりません。"
            f"利用可能: {available}"
        )

    template_info = TEMPLATES[template_name]
    required_params = template_info["params"]

    # 必要なパラメータの確認
    missing = [p for p in required_params if p not in kwargs]
    if missing:
        raise KeyError(
            f"テンプレート '{template_name}' に必要なパラメータが不足しています: "
            f"{', '.join(missing)}"
        )

    # テンプレートバリアントの選択
    # 1. trend_analysis: topic の有無で切り替え
    if template_name == "trend_analysis" and "topic" not in kwargs:
        template = template_info["template_default"]
    # 2. hours を持つ任意パラメータ: hours の有無で切り替え
    elif "hours" in kwargs and "template_with_hours" in template_info:
        template = template_info["template_with_hours"]
    else:
        template = template_info["template"]

    prompt = template.format(**kwargs)

    # 共通サフィックスを付加
    return prompt + COMMON_SUFFIX
